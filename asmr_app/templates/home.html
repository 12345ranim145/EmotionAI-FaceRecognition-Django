{% extends 'base.html' %}
{% load static %}

{% block content %}
<h1 class="text-center mb-4">Reconnaissance Faciale pour Accès ASMR</h1>
<p class="text-center">Ouvrez votre caméra pour vérification.</p>
<div class="text-center">
    <video id="video" width="640" height="480" autoplay class="border border-success rounded"></video>
    <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>
    <img id="processedFrame" width="640" height="480" style="display:none;">
    <button id="startRecognition" class="btn btn-primary mt-3">Démarrer Reconnaissance</button>
    <audio id="welcomeAudio" style="display:none;"></audio>
</div>
<div id="message" class="alert mt-3" style="display:none;"></div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');
    const processedImg = document.getElementById('processedFrame');
    const startBtn = document.getElementById('startRecognition');
    const welcomeAudio = document.getElementById('welcomeAudio');
    const messageDiv = document.getElementById('message');

    startBtn.addEventListener('click', async () => {
        try {
            console.log("Requesting camera access...");
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            console.log("Camera stream started");
            startBtn.disabled = true;
            setTimeout(captureFrame, 2000);
        } catch (err) {
            console.error("Camera error:", err);
            messageDiv.textContent = 'Erreur caméra: ' + err.message;
            messageDiv.classList.add('alert-danger');
            messageDiv.style.display = 'block';
        }
    });

    function captureFrame() {
        context.drawImage(video, 0, 0, 640, 480);
        const imageData = canvas.toDataURL('image/jpeg').split(',')[1];
        console.log("Sending frame to /recognize/");
        fetch('/recognize/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ image: imageData })
        })
        .then(response => response.json())
        .then(data => {
            console.log("Received response:", data);
            if (data.success) {
                messageDiv.textContent = `Bonjour ${data.name}, vous pouvez accéder à votre détecteur ASMR AI`;
                messageDiv.classList.add('alert-success');
                messageDiv.style.display = 'block';
                processedImg.src = 'data:image/jpeg;base64,' + data.processed_image;
                processedImg.style.display = 'block';
                video.style.display = 'none';
                if (data.audio_url) {
                    console.log("Playing welcome audio:", data.audio_url);
                    welcomeAudio.src = data.audio_url;
                    welcomeAudio.play().catch(err => {
                        console.error("Audio play error:", err);
                        messageDiv.textContent = 'Erreur lecture audio: ' + err.message;
                        messageDiv.classList.add('alert-danger');
                        messageDiv.style.display = 'block';
                    });
                }
                setTimeout(() => { window.location.href = '/asmr/'; }, 3000);
            } else {
                messageDiv.textContent = 'Accès refusé. Visage non reconnu.';
                messageDiv.classList.add('alert-danger');
                messageDiv.style.display = 'block';
                startBtn.disabled = false;
            }
        })
        .catch(err => {
            console.error("Fetch error:", err);
            messageDiv.textContent = 'Erreur serveur: ' + err.message;
            messageDiv.classList.add('alert-danger');
            messageDiv.style.display = 'block';
            startBtn.disabled = false;
        });
    }
</script>
{% endblock %}